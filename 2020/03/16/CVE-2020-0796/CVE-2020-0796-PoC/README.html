<h1 id="CVE-2020-0796-PoC-aka-CoronaBlue-aka-SMBGhost"><a href="#CVE-2020-0796-PoC-aka-CoronaBlue-aka-SMBGhost" class="headerlink" title="CVE-2020-0796 PoC aka CoronaBlue aka SMBGhost"></a>CVE-2020-0796 PoC aka CoronaBlue aka SMBGhost</h1><h2 id="Usage"><a href="#Usage" class="headerlink" title="Usage"></a>Usage</h2><p><code>./CVE-2020-0796.py servername</code></p>
<p>This script connects to the target host, and compresses the authentication request with a bad offset field set in the transformation header, causing the decompressor to buffer overflow and crash the target.</p>
<p>This contains a modification of the excellent <a href="https://github.com/jborean93/smbprotocol">smbprotocol</a> with added support for SMB 3.1.1 compression/decompression (only LZNT1). Most of the additions are in <code>smbprotocol/connection.py</code>. A version of <a href="https://github.com/you0708/lznt1">lznt1</a> is included, modified to support Python 3.</p>
<p>The compression transform header is in the <code>SMB2CompressionTransformHeader</code> class there. The function <code>_compress</code> is called to compress tree requests. This is where the offset field is set all high to trigger the crash.</p>
<pre><code class="python"><span class="function"><span class="keyword">def</span> <span class="title">_compress</span><span class="params">(self, b_data, session)</span>:</span>
    header = SMB2CompressionTransformHeader()
    header[<span class="string">'original_size'</span>] = len(b_data)
    header[<span class="string">'offset'</span>] = <span class="number">4294967295</span>
    header[<span class="string">'data'</span>] = smbprotocol.lznt1.compress(b_data)
</code></pre>
<h2 id="About"><a href="#About" class="headerlink" title="About"></a>About</h2><p>CVE-2020-0796 is a bug in Windows 10 1903/1909â€™s new SMB3 compression capability. SMB protocol version 3.1.1 introduces the ability for a client or server to advertise compression cabilities, and to selectively compress SMB3 messages as beneficial. To accomplish this, when negotiating an SMB session, the client and server must both include a <code>SMB2_COMPRESSION_CAPABILITIES</code> as documented in <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-smb2/78e0c942-ab41-472b-b117-4a95ebe88271">MS-SMB2 2.2.3.1.3</a>.</p>
<p>Once a session is negotiated with this capability, either the client or the server can selectively compress certain SMB messages. To do so, the entire SMB packet is compressed, and a transformed header is prepended, as documented in <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-smb2/1d435f21-9a21-4f4c-828e-624a176cf2a0">MS-SMB2 2.2.42</a>. This header is a small (16 bytes) structure with a magic value, the uncompressed data size, the compression algorithm used, and an offset value.</p>
<p>CVE-2020-0796 is caused by a lack of bounds checking in that offset size, which is directly passed to several subroutines. Passing a large value in will cause a buffer overflow, and crash the kernel. With further work, this could be developed into a RCE exploit.</p>
